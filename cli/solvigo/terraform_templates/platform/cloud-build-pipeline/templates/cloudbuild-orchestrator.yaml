# Cloud Build Orchestrator - {{ client }}/{{ project }}
# Generated by Solvigo CLI
#
# Orchestrates parallel builds for: {{ service_types|join(', ') }}
# Single trigger per environment with parallel service deployment

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: ALLOW_LOOSE

timeout: '1800s'  # 30 minutes for full orchestration

substitutions:
  _IMAGE_TAG: '$SHORT_SHA'

steps:
{% if has_backend %}
  # ============================================================================
  # BACKEND SERVICE - Build and Push
  # ============================================================================

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend-image'
    args:
      - 'build'
      - '--cache-from'
      - '$_ARTIFACT_REPO/{{ backend_service_name }}:latest'
      - '-t'
      - '$_ARTIFACT_REPO/{{ backend_service_name }}:$_IMAGE_TAG'
      - '-t'
      - '$_ARTIFACT_REPO/{{ backend_service_name }}:latest'
      - '-t'
      - '$_ARTIFACT_REPO/{{ backend_service_name }}:$_ENVIRONMENT'
      - '-f'
      - '{{ backend_dockerfile }}'
      - '{{ backend_build_context }}'
    timeout: '600s'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend-image'
    args:
      - 'push'
      - '--all-tags'
      - '$_ARTIFACT_REPO/{{ backend_service_name }}'
    waitFor: ['build-backend-image']
    timeout: '300s'
{% endif %}

{% if has_frontend %}
  # ============================================================================
  # FRONTEND SERVICE - Build and Push
  # ============================================================================

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend-image'
    args:
      - 'build'
      - '--cache-from'
      - '$_ARTIFACT_REPO/{{ frontend_service_name }}:latest'
      - '-t'
      - '$_ARTIFACT_REPO/{{ frontend_service_name }}:$_IMAGE_TAG'
      - '-t'
      - '$_ARTIFACT_REPO/{{ frontend_service_name }}:latest'
      - '-t'
      - '$_ARTIFACT_REPO/{{ frontend_service_name }}:$_ENVIRONMENT'
      - '-f'
      - '{{ frontend_dockerfile }}'
      - '{{ frontend_build_context }}'
    timeout: '600s'
    # Run in parallel with backend build (no waitFor)

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend-image'
    args:
      - 'push'
      - '--all-tags'
      - '$_ARTIFACT_REPO/{{ frontend_service_name }}'
    waitFor: ['build-frontend-image']
    timeout: '300s'
{% endif %}

{% if has_backend and has_database %}
  # ============================================================================
  # BACKEND MIGRATIONS - Must run AFTER backend push, BEFORE backend deploy
  # ============================================================================

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'run-backend-migrations'
    entrypoint: gcloud
    args:
      - 'run'
      - 'jobs'
      - 'execute'
      - '{{ migration_job_name }}'
      - '--region=$_REGION'
      - '--project=$_GCP_PROJECT'
      - '--wait'
    waitFor: ['push-backend-image']
    timeout: '600s'
{% endif %}

  # ============================================================================
  # DEPLOYMENT PHASE - Deploy all services in parallel
  # ============================================================================

{% if has_backend %}
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-backend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '{{ backend_service_name }}'
      - '--image=$_ARTIFACT_REPO/{{ backend_service_name }}:$_IMAGE_TAG'
      - '--region=$_REGION'
      - '--platform=managed'
      - '--project=$_GCP_PROJECT'
      - '--allow-unauthenticated'
      # Backend-specific settings
      # - '--vpc-connector=solvigo-vpc-connector'
      # - '--set-cloudsql-instances=$_DB_INSTANCE'
      # - '--set-env-vars=ENV=$_ENVIRONMENT'
      # - '--set-secrets=DB_PASSWORD=db-password:latest,API_KEY=api-key:latest'
      # - '--max-instances=10'
      # - '--min-instances=0'
      # - '--cpu=1'
      # - '--memory=512Mi'
    waitFor: [{% if has_database %}'run-backend-migrations'{% else %}'push-backend-image'{% endif %}]
    timeout: '900s'
{% endif %}

{% if has_frontend %}
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-frontend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '{{ frontend_service_name }}'
      - '--image=$_ARTIFACT_REPO/{{ frontend_service_name }}:$_IMAGE_TAG'
      - '--region=$_REGION'
      - '--platform=managed'
      - '--project=$_GCP_PROJECT'
      - '--allow-unauthenticated'
      # Frontend-specific settings
      # - '--set-env-vars=REACT_APP_API_URL=https://api.$_DOMAIN'
      # - '--max-instances=5'
      # - '--min-instances=0'
      # - '--cpu=1'
      # - '--memory=256Mi'
    waitFor: ['push-frontend-image']
    timeout: '900s'
{% endif %}

  # ============================================================================
  # SMOKE TESTS (Optional)
  # ============================================================================
  # Uncomment to enable health checks after deployment

{% if has_backend %}
  # - name: 'gcr.io/cloud-builders/curl'
  #   id: 'smoke-test-backend'
  #   args: ['-f', 'https://{{ backend_service_name }}-$_ENVIRONMENT.{{ domain }}/health']
  #   waitFor: ['deploy-backend']
{% endif %}

{% if has_frontend %}
  # - name: 'gcr.io/cloud-builders/curl'
  #   id: 'smoke-test-frontend'
  #   args: ['-f', 'https://{{ frontend_service_name }}-$_ENVIRONMENT.{{ domain }}']
  #   waitFor: ['deploy-frontend']
{% endif %}

# Track all built images
images:
{% if has_backend %}
  - '$_ARTIFACT_REPO/{{ backend_service_name }}:$_IMAGE_TAG'
  - '$_ARTIFACT_REPO/{{ backend_service_name }}:latest'
  - '$_ARTIFACT_REPO/{{ backend_service_name }}:$_ENVIRONMENT'
{% endif %}
{% if has_frontend %}
  - '$_ARTIFACT_REPO/{{ frontend_service_name }}:$_IMAGE_TAG'
  - '$_ARTIFACT_REPO/{{ frontend_service_name }}:latest'
  - '$_ARTIFACT_REPO/{{ frontend_service_name }}:$_ENVIRONMENT'
{% endif %}
